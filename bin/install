#!/bin/bash

# if brew is not installed
if ! [ -x "$(command -v brew)" ]; then
  # Install Homebrew
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

if [ ! -f /usr/bin/gcc ]; then
  sudo apt update -y
  sudo apt install build-essential -y
fi

eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
if ! [ -x "$(command -v stow)" ]; then
  brew install stow
fi

ulimit -n 20000
if [[ $(ulimit -Sn) -lt 20000 ]]; then
  echo "Limit of open files is too low ($(ulimit -Sn)), please increase it to 20k or more"
  exit 1
fi

source $HOME/.profile

if [ ! -f /usr/bin/add-apt-repository ]; then
  sudo apt install software-properties-common -y
fi

echo "Apt-Repositories:"
for file in $(dirname "$0")/../config/*/.apt.repos/*; do
  cat $file
  cat $file | xargs sudo add-apt-repository -y
done

sudo apt update -y

echo "Apt-Get:"
for file in $(dirname "$0")/../config/*/.apt.d/*; do
  cat $file
  cat $file | xargs sudo apt-get install -qq -y
done

echo "Brew:"
for file in $(dirname "$0")/../config/*/.brewfile.d/*; do
  cat $file
  cat $file | xargs brew install -q
done
